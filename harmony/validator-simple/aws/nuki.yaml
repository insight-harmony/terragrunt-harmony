---

version_:
  type: yaml
  path: versions.yaml

provider:
  type: stat
  input: aws

region:
  type: stat
  input: "{{ nuki.item }}"

k8s-config:
  type: nukikata
  merge: true
  template: https://github.com/insight-harmony/terraform-harmony-aws-node
  checkout: "{{ nuki.version_[nuki.environment] }}"
  existing_context: "{{ nuki }}"

# Write the deployment file
deployment_exists_:
  type: path_exists
  path: "{{nuki.deployments_dir_}}/{{nuki.namespace}}.{{nuki.network_name}}.{{nuki.shard}}.{{nuki.environment}}.{{nuki.item}}.{{nuki.item}}.yaml"

deployment_overwrite_:
  type: confirm
  message: |
    Do you want to overwrite the existing polkadot.api.{{nuki.network_name}}.{{nuki.environment}}.{{nuki.region}}
    deployment? - will exit program ->
  when: "{{ nuki.deployment_exists_ }}"

deployment_write_:
  type: yaml
  loop: "{{ nuki.aws_regions_ }}"
  path: "{{nuki.deployments_dir_}}/polkadot.api.{{nuki.network_name}}.{{nuki.environment}}.{{nuki.item}}.yaml"
  contents: "{{ nuki }}"
  remove:
    - ^_
    - _$

# Apply
apply_confirm_:
  type: confirm
  message: Do you want deploy now?

id_write_:



apply_:
  type: nukikata
  context_file: "{{ nuki.scripts_dir_ }}/apply.yaml"
  loop: "{{ nuki.aws_regions_ }}"
  when: "{{ nuki.apply_confirm_ }}"
  existing_context:
    template_path: "{{ nuki.provider }}.variables.hcl.j2"
    file_system_loader: "{{ nuki.file_system_loader_ }}"
    namespace: "{{ nuki.namespace }}"
    stack: "{{ nuki.stack }}"
    network_name: "{{ nuki.network_name }}"
    environment: "{{ nuki.environment }}"
    provider: "{{ nuki.provider }}"
    region: "{{ nuki.region }}"

